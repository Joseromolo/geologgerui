<!doctype html>
<html>
  <head>
    <title>TAGS: Datasets</title>
    <meta charset="utf-8">

    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://code.jquery.com/ui/1.10.2/jquery-ui.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
    
    <script src="bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="js/cybercommons.js" type="text/javascript"></script>
    <script src="lib/spin.min.js"></script>
    <script src="js/dataset_parser.js"></script>
    <script src="js/log.js"></script>
    <script src="js/new.js"></script>
    <script src="js/jquery.cookie.js"></script>

    <link href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.min.css" rel="stylesheet">
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/index.css" rel="stylesheet">

  </head>
  <body>

    <div class="navbar navbar-static-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="index.html">TAGS</a>
          <ul class="nav">
            <li><a href="index.html">Datasets</a></li>
            <li><a href="http://animalmigration.org/TAGS/help.htm" target="_new">Help</a></li>
          </ul>
          <ul class="nav pull-right">
            <li><a href="http://tags.animalmigration.org/accounts/login/" id="login-link">Login</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container" id="content">
      <div class="row">
        <div class="span4">
          <ul class="nav nav-list well" id="datasets">
            
            <li>
              <span class="pull-right" id="progress-indicator"></span>
              <form class="form-search">
              <div class="input-append">
                <input type="text" class="span2 search-query" id="search-field" placeholder="search datasets">
                <button type="submit" id="search-btn" class="btn">Search</button>
              </div>
              </form>
            </li>
            <li>
              <a href="#new" class="newdataset-link">Upload a new datastet</a>
            </li>

            <li class="divider"></li>

            <li class="nav-header">My Datasets</li>

            <!-- datasets here -->
            <ul id="sets" class="nav nav-list">

            </ul>
          </ul>

        </div> <!-- span4: nav -->
        <div class="span8">
          <!--<h3>Overview</h3>-->
          <div id="main">

            <div id="index">
              <!--<h3>Welcome to TAGS</h3>
              <h4>Totally Awesome Geolocator Service</h4>
              <p style="margin-top:40px">&nbsp;</p>-->
              <img src="img/logos/tags_logo.jpg" class="logo" id="tags-logo">
              <p class="instructions">
                Select a dataset from the left, or
                <a href="#new" class="newdataset-link">upload a new datastet</a>
              </p>
              <p style="margin-top:40px;">
                If you would like to upload private datasets, <br>
                <a href="http://tags.animalmigration.org/accounts/login/">login</a> or
                <a href="http://tags.animalmigration.org/accounts/login/">create an account</a>
                with Cybercommons.
              </p>
              <div class="footer">
                <img src="img/logos/obs_logo.gif" class="logo">
                <img src="img/logos/nsf_logo.gif" class="logo">
                <img src="img/logos/nceas_logo.png" class="logo">
                <img src="img/logos/cornell_logo.jpg" class="logo">
                <img src="img/logos/mpg_logo.png" class="logo">
                <img src="img/logos/unknown_logo.gif" class="logo">
                <img src="img/logos/movebank_logo.png" class="logo">
                <img src="img/logos/imas_utas_logo.jpg" class="logo">
                <img src="img/logos/cybercommons_logo.png" class="logo">
              </div>
            </div>

            <!-- introduction, alerts, show -->
            <div id="viewbird"></div>
            <div id="newbird" style="display:none;">

              <div id="upload-success" class="alert alert-success">
                <h4>Upload complete</h4>
                <p><span class="title">Filename</span> was successfully uploaded. 
                <a class="link" href="#">Take me there</a></p>
              </div>

              <div id="upload-error" class="alert alert-error">
                <h4>Upload failed</h4>
                <p>There was a problem uploading the data. You might try again in a few minutes.</p>
              </div>

              <h3>Upload dataset <span class="pull-right upload-help"><a href="http://animalmigration.org/TAGS/help.htm" target="_new">Help</a></span></h3>
              <form id="create-new-dataset" action="">
                <fieldset>
                  <legend class="select-file">1. Select a file and set additional fields</legend>
                  
                  <input type="file" id="file-input">
                  <div id="drop-zone">
                    <div class="or-drop">Or drop a file here</div>
                  </div>

                  <div class="row">
                    <div class="span4">

                      <div class="control-group field" id="name">
                        <label for="name">Name</label>
                        <div class="controls">
                          <input type="text" name="name" class="input-xlarge">
                          <span class="help-inline"></span>
                        </div>
                      </div>

                      <div class="control-group field" id="species">
                        <label for="species">Species</label>
                        <div class="controls">
                          <input type="text" name="species" class="input-xlarge">
                          <span class="help-inline"></span>
                        </div>
                      </div>

                    </div>
                    <div class="span4">

                      <div class="control-group field" id="notes">
                        <label for="species">Notes</label>
                        <div class="controls">
                          <textarea rows="5" name="notes" class="input-xlarge"></textarea>
                        </div>
                      </div>

                    </div>
                  </div>
                </fieldset>
                
                <!--
                <fieldset>
                  <legend>2. Release information</legend>
                  <p><small>Latitude values between -90 and 90, 
                    longitude values between -180 and 180</small></p>
                  <div class="row">
                    <div class="span2">

                      <div class="control-group field" id="release-latitude">
                        <label for="release-latitude">Latitude:</label>
                        <div class="controls">
                          <input type="text" name="release-latitude" class="input-small">
                          <span class="help-inline"></span>
                        </div>
                      </div>

                    </div>
                    <div class="span2">

                      <div class="control-group field" id="release-longitude">
                        <label for="release-longitude">Longitude:</label>
                        <div class="controls">
                          <input type="text" name="release-longitude" class="input-small">
                          <span class="help-inline"></span>
                        </div>
                      </div>

                    </div>
                    <div class="span3">

                      <div class="control-group">
                        <label class="control-label" for="release-date">Date</label>
                        <div class="controls">
                          <input type="text" class="span2" name="release-date" placeholder="yyyy-mm-dd">
                        </div>
                      </div>
                    </div>

                  </div>
                </fieldset>
                -->
                <!--
                <fieldset>
                  <legend>3. Recapture information</legend>
                  <div class="row">
                    <div class="span2">

                      <div class="control-group field" id="capture-latitude">
                        <label for="capture-latitude">Latitude:</label>
                        <div class="controls">
                          <input type="text" name="capture-latitude" class="input-small">
                          <span class="help-inline"></span>
                        </div>
                      </div>

                    </div>
                    <div class="span2">

                      <div class="control-group field" id="capture-longitude">
                        <label for="capture-longitude">Longitude:</label>
                        <div class="controls">
                          <input type="text" name="capture-longitude" class="input-small">
                          <span class="help-inline"></span>
                        </div>
                      </div>

                    </div>
                    <div class="span3">

                      <div class="control-group">
                        <label class="control-label" for="capture-date">Date</label>
                        <div class="controls">
                          <input type="text" class="span2" name="capture-date" placeholder="yyyy-mm-dd">
                        </div>
                      </div>

                    </div>
                  </div>
                </fieldset>
                -->

                <hr>
                <div class="actions">
                  <input type="submit" class="btn" value="Upload dataset">
                  <span id="validation-error" class="text-error">
                    Please complete the fields highlighted in red
                  </span>
                </div>
                <div class="uploading-notification">
                  <p class="text-info">
                    <span id="upload-indicator"></span>
                    Uploading data. This may take a few minutes. 
                    Please do not leave the page.
                  </p>
                </div>

              </form>
            </div>
          </div>
        </div> <!-- span8: main -->
      </div>
    </div>

    <div id="login-message" title="Please log in">
      <p>In order to upload files you must first be logged in.</p>
    </div>

    <script tye="text/template" class="upload-success">

    </script>

    <script type="text/template" class="dataset-info-template">
      <strong>{{=filename}}</strong>
      <br><small>Format: {{=format}}, {{=datacount}} time-stamped light values</small>
    </script>

    <script type="text/template" class="datasets-template">
      <li class="dataitem" data-object-id="{{=d.tagname}}"><a href="/datasets/{{=d.tagname}}" data-object-id="{{=d.tagname}}" class="dataset-link">{{=d.tagname}}<span class="date"><small>{{=d.date.toDateString()}}</small></span></a></li>
    </script>

    <script type="text/template" class="show-dataset-template">
      <!--<a href="{{=d.tagname}}/edit" class="pull-right show-edit">Edit</a>-->
      <h3>{{=d.tagname}}</h3>
      <p>Created on {{=d.date.toDateString()}}</p>
      <p>{{=d.notes}}</p>

      <br>
      <h4>Process this data</h4>
      
      <table class="table table-bordered">
        <thead>
          <tr>
            <th width="66%" colspan="2">Step</th>
            <!--<th>Status</th>-->
          </tr>
        </thead>
        <tbody>
          <tr>
            <td width="5%">1.</td>
            <td><a href="calibrate.html#{{=d.tagname}}">GeoLight <span class="raquo">&raquo;</span></a></td>
            <!--<td>Requires action</td>-->
          </tr>
          <!--
          <tr>
            <td>2.</td>
            <td><a href="edit_thresholds#{{=d.tagname}}">Edit light thresholds <span class="raquo">&raquo;</span></a></td>
            <td><span class="muted">Complete previous step</span></td>
          </tr>
          -->
        </tbody>
      </table>
      <!--
      <br>
      <h4>View results (coming)</h4>
      <p><a href="#" class="muted">View map</a></p>
      <p><a href="#" class="muted">View report</a></p>
      -->
    </script>

    <script type="text/javascript">
      
      // globally define functions so they are accessible from other scripts

      var app = app || {};
      app.host = "http://tags.animalmigration.org";

      var datasets = undefined;

      // required for rails
      _.templateSettings = {
        interpolate: /\{\{=(.+?)\}\}/g,
        evaluate: /\{\{(.+?)\}\}/g
      };

      // jquery for spinner
      $.fn.spin = function(opts) {
        this.each(function() {
          var $this = $(this),
              data = $this.data();

          if (data.spinner) {
            data.spinner.stop();
            delete data.spinner;
          }
          if (opts !== false) {
            data.spinner = new Spinner($.extend({color: $this.css('color')}, opts)).spin(this);
          }
        });
        return this;
      };

      function showDatasets(callback) {
        
        var url = app.host + "/geologger/lightlogs/tagname/";
        url += "?callback=?"

        $.getJSON(url)
          .always(function() {
            $('#progress-indicator').spin(false);
          })
          .fail(function(jqXHR, status) {
            log("failed", status);
          })
          .done(function(data) {
            $('#datasets #sets').empty();
            cleanupDatasets(data)
            injectDatasets(data);
            updateDatasetsEventHandlers();
            datasets = data;

            if (callback) {
              callback();
            }
          });
      }

      function cleanupDatasets(ds) {
        _.each(ds,function(d) {
          d.date = new Date(d.timestamp);
        });
      }

      function injectDatasets(ds) {
        var template = _.template($('script.datasets-template').html());
        _.each(ds, function(el) {
          addDatasetToList(el, template);
        });
      }

      function addDatasetToList(el, template) {
        $('#datasets #sets').append(
          template({d:el})
        );
      }

      function updateDatasetsEventHandlers() {
        $('.dataset-link').click(function() {
          $('#index').hide();
          $('#newbird').hide();
          $('#viewbird').show();
          $('#datasets li').removeClass('active');
          $(this).parent('li').addClass('active');
          loadDataset($(this).attr('data-object-id'));
          return false;
        });
        $('.newdataset-link').click(function() {
          if (!isLoggedIn()) {
            $( "#login-message" ).dialog("open");
            return;
          }

          $('#index').hide();
          $('#newbird').show();
          $('#viewbird').hide();
          $('#datasets li').removeClass('active');
          $(this).parent('li').addClass('active');
          return false;
        });
      }

      // show a dataset

      function loadDataset(n) {
        var dataset = _.find(datasets, function(d) {
          return d.tagname == n;
        });
        injectDataset(dataset);
      }

      function injectDataset(d) {
        var template = _.template($('script.show-dataset-template').html());
        $('#viewbird').html(
          template({d:d})
        );
      }

      function searchDatasets(input) {
        var text = new RegExp(input, "i");
        var filteredOut = _.filter(datasets, function(d) {
          return !d.tagname.match(text);
        });
        $('.dataitem').show();
        _.each(filteredOut, function(d) {
          $('li[data-object-id="'+d.tagname+'"]').hide();
        });
      }

      function isLoggedIn() {
        return $.cookie('auth_tkt');
      }

      // but defer interface hookup and load execution until the page is ready

      $(function() {
        "use strict";

        // inteface hookup: search the datasets

        $('#search-btn').click(function() {
          searchDatasets($('#search-field').val());
          return false;
        });

        $('#search-field').on('input', function(e) {
          searchDatasets($(this).val());
          return false;
        });

        // change login/logout label

        if (isLoggedIn()) {
          $('#login-link').attr('href', 'http://tags.animalmigration.org/accounts/logout/');
          $('#login-link').text("Logout");
        } else {
          $('#login-link').attr('href', 'http://tags.animalmigration.org/accounts/login/');
          $('#login-link').text("Login");
        }

        // set up the login dialog

        $( "#login-message" ).dialog({
          modal: true,
          autoOpen: false,
          buttons: {
            Login: function() {
              $(this).dialog("close");
              window.location = "http://tags.animalmigration.org/accounts/login/";
            },
            Close: function() {
              $(this).dialog("close");
            }
          }
        });

        // and do the deed: load the datasets

        $('#progress-indicator').spin({
          color: '#333',
          radius: 4,
          width: 2
        });

        showDatasets();

      });
    </script>

  </body>
</html>
