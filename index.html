<!doctype html>
<html>
  <head>
    <title>Datasets</title>
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
    
    <script src="bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="lib/spin.min.js"></script>
    <script src="js/log.js"></script>
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <script type="text/javascript">
      $(function() {
        "use string";

        var datasets = undefined;

        // required for rails
        _.templateSettings = {
          interpolate: /\{\{=(.+?)\}\}/g,
          evaluate: /\{\{(.+?)\}\}/g
        };

        // jquery for spinner
        $.fn.spin = function(opts) {
          this.each(function() {
            var $this = $(this),
                data = $this.data();

            if (data.spinner) {
              data.spinner.stop();
              delete data.spinner;
            }
            if (opts !== false) {
              data.spinner = new Spinner($.extend({color: $this.css('color')}, opts)).spin(this);
            }
          });
          return this;
        };

        // load the datasets

        $('#progress-indicator').spin({
          color: '#333',
          radius: 4,
          width: 2
        });

        var url = 'http://test.cybercommons.org/mongo/db_find/geologger/lightlogs/';
        url += '{"fields":["tagname", "timestamp", "notes","release_location"]}';

        $.getJSON(url)
          .always(function() {
            $('#progress-indicator').spin(false);
          })
          .fail(function(jqXHR, status) {
            log("failed", status);
          })
          .done(function(data) {
            log("completed",data);
            cleanupDatasets(data)
            injectDatasets(data);
            updateDatasetsEventHandlers();
            datasets = data;
          });

        /*
        $.ajax({
          url: "/datasets.json", dataType: "json",
          success: function(d) {
            $('#progress-indicator').spin(false);
            injectDatasets(d);
            updateDatasetsEventHandlers();
          },
          error: function() {
            $('#progress-indicator').spin(false);
            log("error");
          }
        });
        */

        function cleanupDatasets(ds) {
          _.each(ds,function(d) {
            d.date = new Date(d.timestamp);
          });
        }

        function injectDatasets(ds) {
          var template = _.template($('script.datasets-template').html());
          _.each(ds, function(el) {
            $('#datasets').append(
              template({d:el})
            );
          });
        }

        function updateDatasetsEventHandlers() {
          $('.dataset-link').click(function() {
            $('#datasets li').removeClass('active');
            $(this).parent('li').addClass('active');
            loadDataset($(this).attr('data-object-id'));
            return false;
          });
        }

        // show a dataset

        function loadDataset(n) {
          var dataset = _.find(datasets, function(d) {
            return d.tagname == n;
          });
          injectDataset(dataset);
          /*
          $.ajax({
            url: "/datasets/"+n+".json", dataType: "json",
            success: function(d) {
              injectDataset(d);
            },
            error: function() {
              log("error");
            }
          });
          */
        }

        function injectDataset(d) {
          var template = _.template($('script.show-dataset-template').html());
          $('#main').html(
            template({d:d})
          );
        }

      });
    </script>

    <style type="text/css">
      #content {
        margin-top: 20px;
      }

      #datasets {
        min-height: 500px;
      }

      #progress-indicator {
        display: inline-block;
        margin: 15px 6px 0 0;
      }

      .show-edit {
        padding-top: 13px;
      }

      .dataset-link .date {
        display: block;
      }

    </style>
  </head>
  <body>

    <script type="text/template" class="datasets-template">
      <li><a href="/datasets/{{=d.tagname}}" data-object-id="{{=d.tagname}}" class="dataset-link">{{=d.tagname}}<span class="date"><small>{{=d.date.toDateString()}}</small></span></a></li>
    </script>

    <script type="text/template" class="show-dataset-template">
      <a href="{{=d.tagname}}/edit" class="pull-right show-edit">Edit</a>
      <h3>{{=d.tagname}}</h3>
      <p>Created on {{=d.date.toDateString()}}</p>
      <p>{{=d.notes}}</p>

      <br>
      <h4>Process this data</h4>
      
      <table class="table table-bordered">
        <thead>
          <tr>
            <th width="66%" colspan="2">Step</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td width="5%">1.</td>
            <td><a href="calibrate.html#{{=d.tagname}}">GeoLight <span class="raquo">&raquo;</span></a></td>
            <td>Requires action</td>
          </tr>
          <!--
          <tr>
            <td>2.</td>
            <td><a href="edit_thresholds#{{=d.tagname}}">Edit light thresholds <span class="raquo">&raquo;</span></a></td>
            <td><span class="muted">Complete previous step</span></td>
          </tr>
          -->
        </tbody>
      </table>

      <br>
      <h4>View results (coming)</h4>
      <p><a href="#" class="muted">View map</a></p>
      <p><a href="#" class="muted">View report</a></p>
    </script>

    <div class="navbar navbar-static-top">
      <div class="navbar-inner">
        <div class="container">
          <span class="brand" href="#">Geologgers</span>
          <ul class="nav">
            <li><a href="index.html">Datasets</a></li>
          </ul>
          <ul class="nav pull-right">
            <!--<li><a href="#">File X, Step Y of Z</a></li>-->
          </ul>
        </div>
      </div>
    </div>

    <div class="container" id="content">
      <div class="row">
        <div class="span4">
          <!--<h3>Datasets</h3>-->
          <ul class="nav nav-list well" id="datasets">
            
            <li>
              <span class="pull-right" id="progress-indicator"></span>
              <form class="form-search">
              <div class="input-append">
                <input type="text" class="span2 search-query" placeholder="search my datasets" disabled>
                <button type="submit" class="btn">Search</button>
              </div>
              </form>
            </li>
            <!--<li>
              <a href="/datasets/new">Upload a new datastet</a>
            </li>-->

            <li class="divider"></li>

            <li class="nav-header">My Datasets</li>
            <!-- datasets here -->
          </ul>

        </div> <!-- span4: nav -->
        <div class="span8">
          <!--<h3>Overview</h3>-->
          <div id="main">
            <!-- introduction, alerts, show -->
          </div>
        </div> <!-- span8: main -->
      </div>
    </div>

  </body>
</html>