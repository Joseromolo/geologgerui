	<!doctype html>
<html>
<head>
	<title>GeoLight Interface</title>
	<meta charset="utf-8">

	<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
	<script src="http://code.jquery.com/ui/1.10.2/jquery-ui.min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
  <script src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>
	<script src="http://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
  <script src="https://gist.github.com/bencevans/4504864/raw/c9ef880071f959398b7cf0b687d4f37c352ea86d/leaflet-google.js"></script>

  <script src="bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
  <script src="lib/spin.min.js" type="text/javascript"></script>
	<script src="lib/d3.v3.min.js" type="text/javascript"></script>
	<script src="lib/tablesort.min.js" type="text/javascript"></script>
	<script src="lib/Blob.js" type="text/javascript"></script>
	<script src="lib/FileSaver.min.js" type="text/javascript"></script>

	<script src="js/utilities.js" type="text/javascript"></script>
	<script src="js/base.js" type="text/javascript"></script>
	<script src="js/log.js"></script>

	<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.min.css" rel="stylesheet">
	<link href="http://netdna.bootstrapcdn.com/font-awesome/3.0.2/css/font-awesome.css" rel="stylesheet">
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css">

  <link rel="stylesheet" href="css/calibrate.css">

</head>
<body>

<div class="navbar navbar-static-top">
  <div class="navbar-inner">
  	<div class="container">
	    <span class="brand" href="">Geologgers</span>
	    <ul class="nav">
	      <li><a href="index.html">Datasets</a></li>
	    </ul>
	    <ul class="nav pull-right">
	    	<li><a href=""></a></li>
	    </ul>
	  </div>
  </div>
</div>

<div class="container">

	<div class="row">
		<div class="span12">

			<div class="btn-toolbar pull-right shortcuts">
			  <div class="btn-group">
			    <button class="btn btn-mini" title="Beginning" data-function="gotoBeginning">
			    	<i class="icon-double-angle-left"></i>
			    </button>
			    <button class="btn btn-mini" title="Previous section: left-arrow" data-function="previousSection">
			    	<i class="icon-angle-left"></i>
			    </button>
			    <button class="btn btn-mini" title="Next section: right-arrow" data-function="nextSection">
			    	<i class="icon-angle-right"></i>
			    </button>
			    <button class="btn btn-mini" title="End" data-function="gotoEnd">
			    	<i class="icon-double-angle-right"></i>
			   	</button>
			  </div>
			  <div class="btn-group">
			    <button class="btn btn-mini" title="Previous error: shift-left-arrow" data-function="gotoPreviousProblem">
			    	<i class="icon-circle-arrow-left"></i>
			    </button>
			    <button class="btn btn-mini" title="Next error: Shift-Right-Arrow" data-function="gotoNextProblem">
			    	<i class="icon-circle-arrow-right"></i>
			    </button>
			  </div>
			  <div class="btn-group">
			    <button class="btn btn-mini" title="Zoom out: z" data-function="zoomOut">
			    	<i class="icon-zoom-out"></i>
			    </button>
			    <button class="btn btn-mini" title="Zoom in: z" data-function="zoomIn">
			    	<i class="icon-zoom-in"></i>
			    </button>
			  </div>
			  
			  <div class="btn-group">
			  	<button class="btn btn-mini" title="Settings" data-function="settings" data-toggle="dropdown">
			  		<i class="icon-cog"></i>
			  	</button>
				  <button href="" class="btn btn-mini" data-toggle="popover" 
				  	data-placement="bottom" title="Keyboard Shortcuts" 
				  	data-content="
							Left arrow: previous section<br>
							Right arrow: next section<br><br>
							Shift + left arrow: previous error<br>
							Shift + right arrow: next error<br><br>
							Z: zoom out<br>
							X: zoom in<br><br>
							O: show +/- 24 hours<br>
							P: show points
							">
						<i class="icon-info-sign"></i>
					</button>
					<ul class="dropdown-menu pull-right" role="menu" aria-labelledby="dropdownMenu">
					  <li><a tabindex="-1" href="#overlay" data-function="toggleSurroundingDays">Overlay +/- 24 hours</a></li>
					  <li><a tabindex="-1" href="#points" data-function="togglePoints">Show individuals data points</a></li>
					</ul>
			  </div>
				
			</div>

			<h3><span class="tagname">PABU222150714_curtailed</span> <span class="muted">GeoLight</span></h3>

		</div>
	</div>

	<!--
	<div class="row ">
		<div class="span12">
			<div class="alert alert-info">
				<button type="button" class="close" data-dismiss="alert">&times;</button>
				<p>
					<strong>Instructions</strong>:
					Calibrate and clean up your dataset to submit it for processing.<br>
					1) Specify a light threshold for twilight events.
					2) Review the problem areas and remove erroneous twilight events.<br>
					3) Set calibration coordinates and a calibration period for the sun angle, or provide a sun angle.
					4) Submit.
				</p>
				<p>
					<strong>Shortcuts</strong>
				</p>
			</div>
		</div>
	</div>
	-->

	<div class="row">
		<div class="span12">

			<div id="chart">
				<div id="activity-indicator">
					<div id="activity-spinner"></div>
					<p>Loading Dataset</p>
				</div>
				<!-- placeholder -->
			</div>

		</div>
	</div>

	<div class="row">
		<div class="span8">
			
			<ul class="nav nav-tabs" id="app-tabs">
			  <li class="active"><a href="#events-tab" data-toggle="tab">Excluded Events</a></li>
			  <li><a href="#map-tab" data-toggle="tab" for="map">Locations Map</a></li>
			</ul>

			<div class="tab-content">
			  <div class="tab-pane active" id="events-tab">
			  	
			  	<script type="text/template" id="event-row">
						<tr data-datetime={{id}} class="event">
							<td data-sort={{id}}><a href="#" data-datetime="{{id}}"><small>{{datetime}}</small></a></td>
							<td><small>{{type}}</small></td>
						</tr>
					</script>

					<table class="table table-condensed table-bordered table-striped" id="table-events">
						<thead>
							<tr>
								<th class="event-header">Excluded Events: Date &amp; Time</th>
								<th class="no-sort">Event Type</th>
							</tr>
						</thead>
						<tbody>
							<tr class="nodata no-sort" data-datetime="0">
								<td colspan="2" class="include">No data</td>
							</tr>
						</tbody>
					</table>
				</div>

			  <div class="tab-pane" id="map-tab">
			  	<!-- map placeholder -->
			  	<div id="map"></div>
			  </div>
			</div>

		</div> <!-- table span -->
		<div class="span4">

			<div class="well control-interface">

				<div class="form-horizontal error-group">
					<div class="control-group">
						<label class="control-label" for="threshold" data-toggle="tooltip" data-trigger="manual" data-placement='left' data-error='tooltip' title="Specify a twilight light level threshold">Light Threshold</label>
    				<div class="controls">
							<div class="input-append">
							  <input type="text" id="threshold-val" class="input-mini">
							  <button class="btn" id="decrease-threshold">-</a>
							  <button class="btn" id="increase-threshold">+</a>
							</div>
						</div>
					</div>
				</div>

				<hr>

				<h5>Calibration Coordinates</h5>
				<div class="form-horizontal error-group">
					<div class="control-group">
						<label class="control-label" for="latitude" data-toggle="tooltip" data-trigger="manual" data-placement='left' data-error='tooltip' title="Specify latitude and longitude">Latitude</label>
						<div class="controls">
			   			<input type="text" class="span2" name="latitude" placeholder="metadata">
			    	</div>
			    </div>
			    <div class="control-group">
						<label class="control-label" for="longitude">Longitude</label>
			   		<div class="controls">
			   			<input type="text" class="span2" name="longitude" placeholder="metadata">
			   		</div>
			   	</div>
				</div>

				<hr>

				<h5>Calibration Period <span class="muted">for sun angle</span></h5>
				
				<div class="form-horizontal error-group">
				  <div class="control-group">
						<label class="control-label" for="cal-start-date" data-toggle="tooltip" data-trigger="manual" data-placement='left' data-error='tooltip' title="Specify start and stop dates with an earlier start date">Start Date</label>   
				    <div class="controls">
				    	<input type="text" class="span2" name="cal-start-date" placeholder="select">
				    </div>
			    </div>
			    <div class="control-group">
						<label class="control-label" for="cal-stop-date">Stop Date</label>   
				    <div class="controls">
				    	<input type="text" class="span2" name="cal-stop-date" placeholder="select">
				    </div>
				 	</div>
				 	<div class="control-group">
				 		<label class="control-label">
				 			<i class="icon-refresh icon-spin" id="sun-angle-indicator" style="position:relative;left:0px;top:-4px;"></i>
				 		</label>
				 		<div class="controls">
				 			<a href="" id="compute-sun-angle">Compute sun angle</a><br>
				 			<span class="xor">OR SUPPLY</span>
				 		</div>
				 	</div>
				 	<div class="control-group error-group">
						<label class="control-label" for="sun-angle" data-toggle="tooltip" data-trigger="manual" data-placement='left' data-error='tooltip' title="Specify a sun angle or compute from calibration period">Sun Angle</label>   
				    <div class="controls">
				    	<div class="input-append">
				    		<input type="text" class="span2" name="sun-angle" style="width:100px" placeholder="angle">
				    		<span class="add-on" style="min-width:14px;">&deg;</span>
				    	</div>
				    </div>
				 	</div>
				</div>

				<hr>

				<button class="submit btn btn-primary" id="submit-for-processing" style="position:relative;">
					<i class="icon-refresh icon-spin" style="position:absolute;left:8px;top:6px;"></i>
					<span class="text">Compute Coordinate Data</span>
				</button>
				<hr>
				<p style="text-align:center;">
				<span class="xor">Downloads</span><br>
	    	<a href="#" id="export-csv">Light-Twilight</a> |
	    	<a href="#" id="export-map">Lat-Lng</a> |
	    	<a href="#" id="export-json">All Data</a>
		    </p>

	    	<!--
				<div class="form-horizontal error-group">
				  <div class="control-group">
						<label class="control-label" for="cal-stop-date"></label>   
				    <div class="controls">
				    	<span class="xor">Downloads</span><br>
				    	<a href="#" id="export-csv">Light-Twilight CSV</a><br>
				    	<a href="#" id="export-json">All Data JSON</a><br>
				    	<a href="#" id="export-map">Lat-Lng CSV</a>
				    </div>
				  </div>
				</div>
				-->
				
				<!--
				<button class="submit btn btn-success" id="export-data">
					Download Data as JSON
				</button>
				-->

			</div> <!-- well -->
		</div> <!-- controls span -->
	</div> <!-- row -->

</div>

<script type="text/javascript" src="app/app.js"></script>
<script type="text/javascript" src="app/chart.js"></script>
<script type="text/javascript" src="app/calibration.js"></script>
<script type="text/javascript" src="app/twilights.js"></script>
<script type="text/javascript" src="app/map.js"></script>

<script>

	$(document).ready(function() {
	//(function() {
		"use strict";

		var DateFormat = "yy-mm-dd";

		// interface preparation

		$('#sun-angle-indicator').hide();
		$('#submit-for-processing i').hide();

		// set up page observers and interactions: data-bindings

		$('[data-toggle=popover]').popover({html:true});

		// latitude and longitude

		app.addObserver('releaseLocation', function(loc) {
			$('input[name=latitude]').val(loc[0]);
			$('input[name=longitude]').val(loc[1]);
		});
		$('input[name=latitude]').change(function() {
			var loc = app.get('releaseLocation');
			loc[0] = $(this).val();
			app.set('releaseLocation',loc);
		});
		$('input[name=longitude]').change(function() {
			var loc = app.get('releaseLocation');
			loc[1] = $(this).val();
			app.set('releaseLocation',loc);
		});

		// threshold

		app.addObserver('threshold', function(t) {
			$('#threshold-val').val(t.toFixed(1));
		});
	  $('#increase-threshold').click(function() {
	  	app.set('threshold',app.get('threshold')+0.1);
	  	return false;
	  });
	  $('#decrease-threshold').click(function() {
	  	app.set('threshold',app.get('threshold')-0.1);
	  	return false;
	  });
	  $('#threshold-val').change(function() {
	  	var t = app.chart.constrainToLightRange( Number($(this).val()) );
	  	app.set('threshold', t);
	  	return false;
	  });
	  $('#threshold-val').keydown(function(e) {
	  	if (e.keyCode == 38) {
	  		app.set('threshold',app.get('threshold')+0.1);
	  	} else if (e.keyCode == 40) {
	  		app.set('threshold',app.get('threshold')-0.1);
	  	}
	  });

	  // calibration period

	  app.addObserver('calibrationPeriod', function(r) {
	  	$('input[name=cal-start-date]').val(
	  		$.datepicker.formatDate(DateFormat,r[0])
	  		);
	  	$('input[name=cal-stop-date]').val(
	  		$.datepicker.formatDate(DateFormat,r[1])
	  		);
	  });
	  $('input[name=cal-start-date]').change(function() {
	  	var daterange = app.get('calibrationPeriod');
	  	daterange[0] = $(this).datepicker('getDate');
	  	app.set('calibrationPeriod',daterange);
	  });
	  $('input[name=cal-stop-date]').change(function() {
	  	var daterange = app.get('calibrationPeriod');
	  	daterange[1] = $(this).datepicker('getDate');
	  	app.set('calibrationPeriod',daterange);
	  });

	  // sun angle

	  app.addObserver('sunangle', function(a) {
	  	$('input[name=sun-angle]').val(a);
	  });
	  $('input[name=sun-angle]').change(function() {
	  	app.set('sunangle',$(this).val());
	  });

	  // control group and their appwide keyboard shortcuts

	  $('[data-function=zoomIn]').click(function() {
	  	app.chart.zoomIn(); return false;
	  });
		$('[data-function=zoomOut]').click(function() {
			app.chart.zoomOut(); return false;
		});
		$('[data-function=previousSection]').click(function() {
			app.chart.gotoPreviousSection(); return false;
		});
		$('[data-function=nextSection]').click(function() {
			app.chart.gotoNextSection(); return false;
		});
		$('[data-function=gotoBeginning]').click(function() {
			app.chart.gotoBeginning(); return false;
		});
		$('[data-function=gotoEnd]').click(function() {
			app.chart.gotoEnd(); return false;
		});
		$('[data-function=gotoPreviousProblem]').click(function() {
			app.twilights.gotoPreviousProblem(); return false;
		});
		$('[data-function=gotoNextProblem]').click(function() {
			app.twilights.gotoNextProblem(); return false;
		});
	  $('[data-function=toggleSurroundingDays]').click(function() { 
	  	app.chart.toggleSurroundingDays(); return false;
	  });
	  $('[data-function=togglePoints]').click(function() { 
	  	app.chart.togglePoints(); return false;
	  });

	  $(document).keydown(function(e) {
	  	if ($('*:focus').prop('tagName') == 'INPUT' )
	  		return;
	  	if (e.which == 37 || e.which == 39) { 
	  		e.preventDefault(); // left or right key
	  		if (e.shiftKey) {
	  			if (app.get('problems').length == 0) return;
	  			if (e.which == 37) app.twilights.gotoPreviousProblem();
	  			if (e.which == 39) app.twilights.gotoNextProblem();
	  		} else {
		  		if (e.which == 37) app.chart.gotoPreviousSection();
		  		if (e.which == 39) app.chart.gotoNextSection();
			  }
		  } else if ( e.which == 88 || e.which == 90 ) {
		  	e.preventDefault(); // z and x keys
		  	if (e.which == 88) app.chart.zoomIn();
		  	if (e.which == 90) app.chart.zoomOut();
		  } else if ( e.which == 79 || e.which == 80 ) {
		  	e.preventDefault(); // o and p keys
		  	if (e.which == 79) app.chart.toggleSurroundingDays();
		  	if (e.which == 80) app.chart.togglePoints();
		  }
	  });

	  // main progress indicator

	  var sp, spinner;
	  app.chart.addObserver('readyState', function(state) {
	  	if ( state == 1) {
				sp = document.getElementById('activity-indicator');
				spinner = new Spinner({color:'#fff'}).spin(document.getElementById('activity-spinner'));
	  	} else if ( state == 2 ) {
			  spinner.stop();
			  sp.parentNode.removeChild(sp);
	  	}
	  });
		
		app.chart.addObserver('readyState', function(state) {
			if ( state == 2 ) {
				$('input[name=cal-start-date], input[name=cal-stop-date]').datepicker({
					showOtherMonths: true,
      		selectOtherMonths: true,
      		defaultDate: new Date(app.chart.domainMin()),
      		minDate: new Date(app.chart.domainMin()),
      		maxDate: new Date(app.chart.domainMax()),
      		dateFormat: DateFormat
				});
			}
		});

		// point updating ~ cannot draw all points simultaneously
		// and datagroup updating ~ optimize

		app.addObserver('extent', function() {
	  	if ( app.chart.pointsVisible() ) {
	  		app.chart.redrawPoints();
	  	}
		});
	  
		// processing
		// ToDo: Remove dummy tag name
		// ToDo: Check for remaining problems

		function pollStatus(args) {
	    $.getJSON(args.host + args.task_id + '?callback=?')
        .fail(function(jqXHR, status) {
        	args.onFailure(jqXHR, status);
        })
        .done(function(data) {
	        if (data.status == "PENDING") {
	          args.onPending(args.task_id);
	        } else if (data.status == "FAILURE") {
	          args.onFailure(data);
	        } else if (data.status == "SUCCESS") {
	          args.onSuccess(data);
	        }
	      });
		}

		function getStatus(taskID) {
			log("fetching status",taskID);
			var promise = new $.Deferred();
			var timer;
			var args = {
				host: 'http://test.cybercommons.org/queue/task/',
				task_id: taskID,
				onFailure: function(data) {
					clearInterval(timer);
					promise.reject(undefined,data);
				},
				onSuccess: function(data) {
					clearInterval(timer);
					promise.resolve(data);
				},
				onPending: function() {
					; // nothing
				}
			}
			timer = setInterval(function () {
				pollStatus(args);
			}, 2000);
			return promise;
		}

		$('#compute-sun-angle').click(function() {
			if (!validateForSunAngle()) return false;

			var $indicator = $('#sun-angle-indicator');

			var url = "http://test.cybercommons.org/queue/run/geologger.getElevation@geologger";
			var data = formattedEventData(app.get('events'),app.get('calibrationPeriod'));
			var postdata = {
				release_location: app.get('releaseLocation'),
				threshold: app.get('threshold'),
				tagname: app.get('tagname'),
				twilights: data
			}
			
			log(postdata);
			
			startProgressIndicator($indicator);
			$.post(url,{data: JSON.stringify(postdata)}, null, "json")
				.fail(function(jqXHR, status) {
					log("post failed", status);
					stopProgressIndicator($indicator);
				})
				.done(function(data) {
					log("post completed",data, typeof data);
					if (!data.task_id) {
						log("no task id returned");
						stopProgressIndicator($indicator);
						return;
					}
					getStatus(data.task_id)
						.always(function() {
							stopProgressIndicator($indicator);
						})
						.fail(function(jqXHR, status) {
							log("failed to retrieve task status",status);
						})
						.done(function(data) {
							var angle = data.tombstone[0].result.sunelevation;
							log("task status resolved", angle, data);
							app.set('angleComputed',true);
							app.set('sunangle',angle);
						});
				});

			return false;
		});

		$('#submit-for-processing').click(function() {
			if (!validateForProcessing()) return false;

			var $indicator = $('#submit-for-processing i');
			var $text = $('#submit-for-processing .text');
			var $btn = $(this);
		
			var url = 'http://test.cybercommons.org/queue/run/geologger.coord@geologger';
		
			var data = formattedEventData(app.get('events'));
			var postdata = {
				threshold: +app.get('threshold'),
				tagname: app.get('tagname'),
				twilights: data,
				calibperiod: app.get('calibrationPeriod'),
				sunelevation: app.get('sunangle'),
				computed: app.get('angleComputed'),
				release_location: app.get('releaseLocation')
			};

			startProgressIndicator($indicator);
			$.post(url,{data: JSON.stringify(postdata)}, null, "json")
				.fail(function(jqXHR, status) {
					log("post failed", status);
					$text.text('Error! Try again in a few seconds');
					$btn.addClass('btn-danger');
					setTimeout(function() {
						$text.text("Submit for processing");
						$btn.removeClass('btn-danger');
						$btn.addClass('btn-primary');
					},8000);
				})
				.done(function(data) {
					log("post completed",data);
					$text.text('Data are being processed');
					
					getStatus(data.task_id)
						.always(function() {
							stopProgressIndicator($indicator);
							$btn.removeClass('btn-primary');
						})
						.fail(function(jqXHR, status) {
							log("failed to retrieve task status",status);
							$text.text('Error! Try again in a few seconds');
							$btn.addClass('btn-danger');
							setTimeout(function() {
								$text.text("Submit for processing");
								$btn.removeClass('btn-danger');
								$btn.addClass('btn-primary');
							},8000);
						})
						.done(function(data) {
							log("status completed, grabbing geojson");
							$text.text('Success! Loading map data');
							$btn.addClass('btn-info');

							$('#app-tabs a[href="#map-tab"]').tab('show');
							getGeoJSON();

							setTimeout(function() {
								$text.text("Submit for processing");
								$btn.removeClass('btn-info');
								$btn.addClass('btn-primary');
							},8000);
						});
				});
		
			return false;
		});

		function getGeoJSON() {

			var url = 'http://test.cybercommons.org/mongo/db_find/geologger/coord/';
			var props = {
				spec: {
					"properties.tagname": app.get('tagname'),
					"properties.user_id": "guest"
				},
				sort: [["properties.timestamp",-1]],
				limit: 1
			}

			url += JSON.stringify(props);

			$.getJSON(url)
				.fail(function(jqXHR, status) {
	        log("geojson get failed", status);
        })
        .done(function(data) {
        	log("post completed",data);
        	app.map.drawGeoJSON(data[0].features);
        	updateCoordinates(data[0].features);
        });
		}

		function updateCoordinates(features) {
			app.set('birdLocations', _.map(features, function(d) {
				return d.geometry.coordinates;
			}));
		}

		function formattedEventData(data,range) {
			// convert datetime fields to tFirst and tSecond for R processing
			var fdata = _.map(data, function(d) { return d.toObject(); });
			if (range) fdata = _.filter(fdata, function(d) {
				return d.datetime >= range[0] && d.datetime <= range[1];
			});

			for (var i = 0; i < fdata.length-1; i++) {
				fdata[i].tFirst = fdata[i].datetime;
				fdata[i].tSecond = fdata[i+1].datetime;
				delete fdata[i].datetime;
				delete fdata[i].threshold;
				delete fdata[i].problem;
			}
			return fdata.slice(0,-1);
		}

		function startProgressIndicator($indicator) {
			$indicator.show();
		}

		function stopProgressIndicator($indicator) {
			$indicator.hide();
		}

		// data validation prior to posting

		function validateForSunAngle() {
			hideAllLabelTooltips();
			if (!lightThresholdIsValid(app.get('threshold'))) {
				showTooltipForLabel('threshold'); 
				return false;
			}
			if (!releaseLocationIsValid(app.get('releaseLocation'))) {
				showTooltipForLabel('latitude'); 
				return false;
			}
			if (!calibrationPeriodIsValid(app.get('calibrationPeriod'))) {
				showTooltipForLabel('cal-start-date'); 
				return false;
			}
			return true;
		}

		function validateForProcessing() {
			hideAllLabelTooltips();
			if (!lightThresholdIsValid(app.get('threshold'))) {
				showTooltipForLabel('threshold');
				return false;
			}
			if (!releaseLocationIsValid(app.get('releaseLocation'))) {
				showTooltipForLabel('latitude');
				return false;
			}
			if (!sunAngleIsValid(app.get('sunangle'))) {
				showTooltipForLabel('sun-angle');
				return false;
			}
			return true;
		}

		function hideAllLabelTooltips() {
			$('label[data-error=tooltip]').tooltip('destroy');
		}

		function showTooltipForLabel(name) {
			$('[for='+name+']').tooltip('show');
		}

		function lightThresholdIsValid(threshold) {
			if (!threshold) return false;
			return true;
		}

		function releaseLocationIsValid(location) {
			if (!location.length==2 || !location[0] || !location[1]) {
				return false;
			} else {
				return true;
			}
		}

		function calibrationPeriodIsValid(period) {
			if (!period.length==2 || !period[0] || !period[1] || 
					 period[0] >= period[1]) {
				return false;
			} else {
				return true;
			}
		}

		function sunAngleIsValid(angle) {
			if (!angle) return false;
			return true;
		}

		// http://stackoverflow.com/questions/280713/elements-order-in-a-for-in-loop
		// All browsers respect definition order with the exception of Chrome and 
		// Opera which do for every non-numerical property name.
		// Really need to test this output

		$('#export-csv').click(function(d) {
			exportAsCSV(tildeData());
			return false;
		});

		$('#export-json').click(function(d) {
			exportAsJSON(tildeData());
			return false;
		});

		$('#export-map').click(function(d) {
			exportMapAsCSV(_.clone(app.get('birdLocations')));
			return false;
		});

		function tildeData() {
			var data = _.map(app.get('data'), function(d) {
				return _.clone(d); // js references are problematic
			});

			// add required csv fields to existing light data

			_.each(data, function(d) {
				d.twilight = 0;
				d.interp = "FALSE";
				d.excluded = "FALSE";
			});

			// format twilight events

			var events = _.map(app.get('events'), function(e) {
				var t = e.toObject();
				var type = 0;
				if (t.type == "sunrise") type = 1;
				else if (t.type == "sunset") type = 2;
				var r = {};

					r.datetime = t.datetime;
					r.light = t.threshold;
					r.twilight = type;
					r.interp = "TRUE";
					r.excluded = (t.active?"FALSE":"TRUE");

				return r;
			});
			
			// add twilight events to light data and sort

			data = data.concat(events);
			data = _.sortBy(data, function(d) {
				return d.datetime;
			});

			// filter out light data that has been duplicated by twilight events
			// and set interp to false for the twilight event

			var dataOut = [];
			for (var i = 0; i < data.length-1; i++) {
				if (data[i].datetime.getTime() != data[i+1].datetime.getTime()) {
					dataOut.push(data[i]);
				} else {
					// ensure the duplication is a light-twilight dup 
					// and not a light-light
					if (data[i+1].twilight != 0) {
						data[i+1].interp = "FALSE";
					}
				}
			}

			return dataOut;
		}

		function exportAsCSV(dataOut) {
			
			// one more pass converting date values to iso

			_.each(dataOut, function(d) {
				d.datetime = d.datetime.toISOString();
			});

			// add csv fields
			dataOut.unshift({
				datetime: 'datetime', 
				light: 'light',
				twilight: 'twilight',
				interp: 'interp',
				excluded: 'excluded'
			});

			var csv = arrayOfObjectsToCSV(dataOut);
			saveAs(
	      new Blob([csv], {
	      	type: "text/csv;charset=" + document.characterSet
	      }), app.get('tagname')+".csv"
	    );
			
			//var uriContent = "data:text/csv;charset=utf-8," + encodeURIComponent(csv);
			//var myWindow = window.open(uriContent, "Tilde CSV");
		}

		function exportAsJSON(dataOut) {

			// R serializes table data rather strangely, but economically
			
			var tilde = {
				datetime: [],
				light: [],
				twilight: [],
				interp: [],
				excluded: []
			}

			_.each(dataOut, function(d) {
				tilde.datetime.push(d.datetime);
				tilde.light.push(d.light);
				tilde.twilight.push(d.twilight);
				tilde.interp.push(d.interp);
				tilde.excluded.push(d.excluded);
			});

			// and we have metadata

			var allOut = {
				tilde: tilde,
				latlngs: app.get('birdLocations'),
				metadata: {
					tagname: app.get('tagname'),
					tagid: app.get('tagname'),
					solar_elevation: app.get('sunangle'),
					calibration: [
						{
							location: app.get('releaseLocation'),
							start_time: app.get('calibrationPeriod')[0],
							stop_time: app.get('calibrationPeriod')[1]
						}
					],
					release_location: app.get('releaseLocation'),
					release_time: "NA",
					recapture_location: "NA",
					recapture_time: "NA",
					notes: app.get('notes'),
					species: "NA"
				}
			}

			var json = JSON.stringify(allOut, null, "  ");
			saveAs(
	      new Blob([json], {
	      	type: "application/json;charset=" + document.characterSet
	      }), app.get('tagname')+".json"
	    );
		}

		function exportMapAsCSV(dataOut) {
			dataOut.unshift(['lat', 'lng']);
			var csv = arrayOfArraysToCSV(dataOut);
			saveAs(
	      new Blob([csv], {
	      	type: "text/csv;charset=" + document.characterSet
	      }), app.get('tagname')+"_latlng.csv"
	    );
		}

		function arrayOfObjectsToCSV(array) {
			var keys = _.keys(array[0]);
			var csv = '';
			_.each(array, function(d) {
				csv += _.map(keys,function(k) {
					return d[k];
				}).join(',');
				csv += '\r\n';
			});
			return csv;
		}

		function arrayOfArraysToCSV(array) {
			var csv = '';
			_.each(array, function(d) {
				csv += d.join(',');
				csv += '\r\n';
			});
			return csv;
		}

		// clear error on input label once editing begins
		
		$('input').focus(function() {
			$(this).parents('.error-group')
				.find('label[data-error=tooltip]')
				.tooltip('destroy');
		}); 

	  function loadChart(filename) {
	  	//app.chart.load("/datasets/"+filename);
	  	$('.tagname').text(filename);
	  	app.chart.load(filename); // error checking
	  }

	  // load the dataset for visualization // ?callback=? jsonp

	  loadChart(window.location.hash.slice(1));	 

  });
	</script>

</body>
</html>