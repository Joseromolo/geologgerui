
<!doctype html>
<html>
  <head>
    <title>Upload New Datasets</title>
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://code.jquery.com/ui/1.10.2/jquery-ui.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>

    <script src="/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="/lib/spin.min.js"></script>
    <script src="/js/cybercommons.js" type="text/javascript"></script>
    <script src="/js/log.js"></script>

    <link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.min.css" rel="stylesheet">

    <style type="text/css">
      #content {
        margin-top: 20px;
      }

      #datasets {
        min-height: 500px;
      }

      #progress-indicator {
        display: inline-block;
        margin: 15px 6px 0 0;
      }

      .show-edit {
        padding-top: 13px;
      }

      .help-inline {
      	padding-bottom: 10px;
      }

      legend {
      	margin-bottom: 10px;
      }

      legend.select-file {
        margin-bottom: 10px;
      }

      /*input[type=file] {
        margin: 10px 0;
      }*/

      #drop-zone {
        border: 2px #ccc dashed;
        margin: 10px 0 30px;
        padding: 20px;
        font-size: 1.2em;
      }
      #drop-zone .or-drop {
        text-align: center;
      }

      input[type=file].error {
        color: #b94a48;
      }

      .file-success {
        border-color: #468847 !important;
        background: #dff0db;
      }

      .file-error {
        border-color: #b94a48 !important;
        background: #f2dede; 
      }

      .file-invalid {
        border-color: #b94a48 !important;
        color: #b94a48;
      }
    </style>

  </head>
  <body>

 		<div class="navbar navbar-static-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="#">Geologgers</a>
          <ul class="nav">
            <li><a href="#">Home</a></li>
          </ul>
          <ul class="nav pull-right">
            <!--<li><a href="#">File X, Step Y of Z</a></li>-->
          </ul>
        </div>
      </div>
    </div>

    <div class="container" id="content">
      <div class="row">
        <div class="span4">
          <!--<h3>Datasets</h3>-->
          <ul class="nav nav-list well" id="datasets">
            
            <li>
              <span class="pull-right" id="progress-indicator"></span>
              <form class="form-search">
              <div class="input-append">
                <input type="text" class="span2 search-query" placeholder="search my datasets">
                <button type="submit" class="btn">Search</button>
              </div>
              </form>
            </li>
            <li class="active">
              <a href="/new.html">Upload a new datastet</a>
            </li>

            <li class="divider"></li>

            <li class="nav-header">My Datasets</li>
            <!-- datasets here -->
          </ul>

        </div> <!-- span4: nav -->

        <div class="span8">
          <!--<h3>Overview</h3>-->
          <div id="main">
            <h3>Upload dataset</h3>
            
            <form id="create-new-dataset" action="">
              <fieldset>
                <legend class="select-file">1. Select a file and set additional fields</legend>
                
                <input type="file" id="file-input">
                <div id="drop-zone">
                  <div class="or-drop">Or drop a file here</div>
                </div>

                <div class="row">
                  <div class="span4">

                    <div class="control-group field" id="name">
                      <label for="name">Name</label>
                      <div class="controls">
                        <input type="text" name="name" class="input-xlarge">
                        <span class="help-inline"></span>
                      </div>
                    </div>

                    <div class="control-group field" id="species">
                      <label for="species">Species</label>
                      <div class="controls">
                        <input type="text" name="species" class="input-xlarge">
                        <span class="help-inline"></span>
                      </div>
                    </div>

                  </div>
                  <div class="span4">

                    <div class="control-group field" id="notes">
                      <label for="species">Notes</label>
                      <div class="controls">
                        <textarea rows="5" name="notes" class="input-xlarge"></textarea>
                      </div>
                    </div>

                  </div>
                </div>
              </fieldset>
              
              <fieldset>
                <legend>2. Release information</legend>
                <p><small>Latitude values between -90 and 90, 
                  longitude values between -180 and 180</small></p>
                <div class="row">
                  <div class="span2">

                    <div class="control-group field" id="release-latitude">
                      <label for="release-latitude">Latitude:</label>
                      <div class="controls">
                        <input type="text" name="release-latitude" class="input-small">
                        <span class="help-inline"></span>
                      </div>
                    </div>

                  </div>
                  <div class="span2">

                    <div class="control-group field" id="release-longitude">
                      <label for="release-longitude">Longitude:</label>
                      <div class="controls">
                        <input type="text" name="release-longitude" class="input-small">
                        <span class="help-inline"></span>
                      </div>
                    </div>

                  </div>
                  <div class="span3">

                    <div class="control-group">
                      <label class="control-label" for="release-date">Date</label>
                      <div class="controls">
                        <input type="text" class="span2" name="release-date" placeholder="yyyy-mm-dd">
                      </div>
                    </div>
                  </div>

                </div>
              </fieldset>
              
              <fieldset>
                <legend>3. Recapture information</legend>
                <div class="row">
                  <div class="span2">

                    <div class="control-group field" id="capture-latitude">
                      <label for="capture-latitude">Latitude:</label>
                      <div class="controls">
                        <input type="text" name="capture-latitude" class="input-small">
                        <span class="help-inline"></span>
                      </div>
                    </div>

                  </div>
                  <div class="span2">

                    <div class="control-group field" id="capture-longitude">
                      <label for="capture-longitude">Longitude:</label>
                      <div class="controls">
                        <input type="text" name="capture-longitude" class="input-small">
                        <span class="help-inline"></span>
                      </div>
                    </div>

                  </div>
                  <div class="span3">

                    <div class="control-group">
                      <label class="control-label" for="capture-date">Date</label>
                      <div class="controls">
                        <input type="text" class="span2" name="capture-date" placeholder="yyyy-mm-dd">
                      </div>
                    </div>

                  </div>
                </div>

                <hr>
                <div class="actions">
                  <input type="submit" class="btn" value="Upload dataset">
                </div>
              </fieldset>
            </form>

          </div>
        </div> <!-- span8: main -->
      </div>
    </div>

  </body>

  <script type="text/javascript">

    _.templateSettings = {
      interpolate: /\{\{=(.+?)\}\}/g,
      evaluate: /\{\{(.+?)\}\}/g
    };

    var eli1 = "datetime,light";
    var eli2 = "2011-06-18 10:24:30,2";
    var bas = "ok,19/02/10 20:16:00,40228.844444,9";
    var sumner = "1  1 2000-10-27 22:44:00     191   NA     0";
    var stefan1 = "datetime        light";
    var stefan2 = "01.07.2010 00:01        2";

    var exp = {
      eli: {
        name: "TAGS",
        header: /(datetime,light)/,
        re: /(\d\d\d\d-\d\d-\d\d \d\d:\d\d:\d\d),(\d+)/,
        parse: function(d) {
          // new Date(d) works as well, but let's be specific
          return new Date(d.replace(' ','T') + 'Z');
        },
        dateIndex: 1,
        lightIndex: 2
      },
      bas: {
        name: "BAS",
        re: /\w*,(\d\d\/\d\d\/\d\d \d\d:\d\d:\d\d),\d+.*\d+,(\d+)/,
        parse: function(d) {
          // day/month/2year
          var day = d.slice(0,2);
              month = d.slice(3,5);
              year = "20" + d.slice(6,8);
              time = d.slice(9,17);
          return new Date(year+"-"+month+"-"+day+"T"+time+"Z");
        },
        dateIndex: 1,
        lightIndex: 2
      }
    };

    console.log(exp.bas.header);

    var eliReg1 = /(datetime,light)/;
    var eli1Match = eli1.match(eliReg1);
    console.log(eli1Match);

    var eli2Reg = /(\d\d\d\d-\d\d-\d\d \d\d:\d\d:\d\d),(\d+)/;
    var eli2Match = eli2.match(eli2Reg);
    console.log(eli2Match);
    console.log(exp.eli.parse(eli2Match[1]));

    var basReg = /\w*,(\d\d\/\d\d\/\d\d \d\d:\d\d:\d\d),\d+.*\d+,(\d+)/;
    var basMatch = bas.match(basReg);
    console.log(basMatch);
    console.log(new Date(exp.bas.parse(basMatch[1])));

    console.log(dataFormat(eli1).name);
    console.log(dataFormat(eli2).name);
    console.log(dataFormat(bas).name);


    function dataFormat(line) {
      var exp = expressions();
      for (var i = 0; i < exp.length; i++) {
        var format = exp[i];
        if (format.header && line.match(format.header)) {
          return format;
        } else if (line.match(format.re)) {
          return format;
        }
      }
      return null;
    }

    function expressions() {
      return [
        {
          name: "TAGS",
          header: /(datetime,light)/,
          hasHeader: true,
          re: /(\d\d\d\d-\d\d-\d\d \d\d:\d\d:\d\d),(\d+)/,
          parse: function(d) {
            // new Date(d) works as well, but let's be specific
            return new Date(d.replace(' ','T') + 'Z');
          },
          dateIndex: 1,
          lightIndex: 2
        },
        {
          name: "BAS",
          re: /\w*,(\d\d\/\d\d\/\d\d \d\d:\d\d:\d\d),\d+.*\d+,(\d+)/,
          parse: function(d) {
            // day/month/2year
            var day = d.slice(0,2);
                month = d.slice(3,5);
                year = "20" + d.slice(6,8);
                time = d.slice(9,17);
            return new Date(year+"-"+month+"-"+day+"T"+time+"Z");
          },
          dateIndex: 1,
          lightIndex: 2
        }
      ];
    }
  </script>

  <script type="text/template" class="dataset-info-template">
    <strong>{{=filename}}</strong>
    <br><small>Format: {{=format}}, {{=datacount}} time-stamped light values</small>
  </script>

  <script type="text/javascript">
    
    $(function() {

      var data = undefined;

      // todo: limit to one

      function handleFileSelect(evt) {
        var files = evt.target.files; // FileList object
        var file = files[0];
        importFile(file);
      }

      function handleFileDrop(evt) {
        evt.stopPropagation();
        evt.preventDefault();

        var files = evt.dataTransfer.files; // FileList object.
        var file = files[0];
        importFile(file);
      }

      function importFile(file) {
        var reader = new FileReader();

        reader.onload = function(f) {
          console.log(f.target.result);
          var lines = f.target.result.trim().split(/\r?\n|\r/g);
          console.log(lines);
          var format = dataFormat(lines[0]);
          console.log(format.name);

          if (format.hasHeader) lines.shift();
          var vals = _.map(lines, function(x) {
            var match = x.match(format.re);
            //console.log(match);
            if (!match) { 
              // this is an error, which we should keep track of
              return undefined; 
            } else { 
              return {
                datetime: format.parse(match[format.dateIndex]),
                light: match[format.lightIndex]
              }
            }
          });

          console.log(vals);

          var template = _.template($('script.dataset-info-template').html());
          $('#drop-zone .or-drop').html(template({
            filename: escape(file.name),
            filesize: file.size,
            format: format.name,
            datacount: vals.length
          }));

          $('#drop-zone').addClass('file-success');
          $('#drop-zone').removeClass("file-invalid");
          $('#file-input').removeClass('error');
          data = vals;
        }
        reader.readAsText(file);
      }

      function handleDragOver(evt) {
        evt.stopPropagation();
        evt.preventDefault();
        evt.dataTransfer.dropEffect = 'copy';
      }

      document.getElementById('file-input').addEventListener('change', handleFileSelect, false);

      var dropZone = document.getElementById('drop-zone');
      dropZone.addEventListener('dragover', handleDragOver, false);
      dropZone.addEventListener('drop', handleFileDrop, false);


      var DateFormat = "yy-mm-dd";
      $('input[name=release-date], input[name=capture-date]').datepicker({
          showOtherMonths: true,
          selectOtherMonths: true,
          defaultDate: new Date(),
          dateFormat: DateFormat
        });


      $('#create-new-dataset').submit(function() {
        if (!validateInput()) return false;
        
        var url = "http://test.cybercommons.org/queue/run/geologger.importTagData@geologger";
        var upload = dataForUpload();
        console.log(JSON.stringify(upload));

        $.post(url, {data: JSON.stringify(upload)}, null, "json").then(function(data) {
          return (new CyberCommons()).getStatusOfTask(data.task_id);
        }).then(function(data) {
          log("post completed", data);
        },function(error) {
          log("post failed", error);
        });

        return false;
      });

      function dataForUpload() {
        return {
          data: data,
          tagname: get('name'),
          species: get('species'),
          notes: getNotes(),
          release_location: getLocation('release'),
          release_time: get('release-date'),
          recapture_location: getLocation('capture'),
          recapture_time: get('capture-date')
        };
      }

      function validateInput() {
        var valid = true;
        valid = validateData() && valid;
        valid = validateName() && valid;
        return valid;
      }

      function validateData() {
        if (!data) {
          $('#drop-zone').addClass("file-invalid");
          $('#file-input').addClass('error');
          return false;
        } else {
          $('#drop-zone').removeClass("file-invalid");
          $('#file-input').removeClass('error');
          return true;
        }
      }

      function validateName() {
        if (get('name').length == 0) {
          $('#name').addClass('error');
          return false;
        } else {
          $('#name').removeClass('error');
          return true;
        }
      }

      function get(id) {
        return $('input[name='+id+']').val().trim();
      }

      function getLocation(id) {
        var lat = parseFloat(get(id+'-latitude'));
        var lon = parseFloat(get(id+'-longitude'));
        if (isNaN(lat) || isNaN(lon)) return [];
        else return [lat, lon];
      }

      function getNotes() {
        return $('textarea[name=notes]').val().trim();
      }

    });
  </script>
</html>
